name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  # Job 1: Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd lambda/task_counter
          pip install -r requirements.txt
          pip install pytest boto3

      - name: Run basic syntax check
        run: |
          python -m py_compile lambda/task_counter/handler.py

  # Job 2: Deploy to DEV
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: dev
      url: http://dev-task-counter-frontend-${{ secrets.AWS_ACCOUNT_ID }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Plan DEV
        run: |
          cd terraform
          terraform plan -var-file=environments/dev/terraform.tfvars

      - name: Terraform Apply DEV
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/dev/terraform.tfvars

      - name: Get API Gateway URL
        id: get-api-url
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.get-api-url.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          cd terraform
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          aws s3 cp ../frontend/index.html s3://$BUCKET_NAME/

      - name: Initialize DynamoDB counter
        run: |
          cd terraform
          TABLE_NAME=$(terraform output -raw dynamodb_table_name)
          aws dynamodb put-item \
            --table-name $TABLE_NAME \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "Testing GET request..."
          curl -f $API_URL
          echo "Testing POST request..."
          curl -f -X POST $API_URL

  # Job 3: Deploy to SIT
  deploy-sit:
    name: Deploy to SIT
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment:
      name: sit
      url: http://sit-task-counter-frontend-${{ secrets.AWS_ACCOUNT_ID }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Apply SIT
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/sit/terraform.tfvars

      - name: Get API Gateway URL
        id: get-api-url
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.get-api-url.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          cd terraform
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          aws s3 cp ../frontend/index.html s3://$BUCKET_NAME/

      - name: Initialize DynamoDB counter
        run: |
          cd terraform
          TABLE_NAME=$(terraform output -raw dynamodb_table_name)
          aws dynamodb put-item \
            --table-name $TABLE_NAME \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "Testing GET request..."
          curl -f $API_URL
          echo "Testing POST request..."
          curl -f -X POST $API_URL

  # Job 4: Deploy to PROD
  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-sit
    environment:
      name: prod
      url: http://prod-task-counter-frontend-${{ secrets.AWS_ACCOUNT_ID }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Apply PROD
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/prod/terraform.tfvars

      - name: Get API Gateway URL
        id: get-api-url
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.get-api-url.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          cd terraform
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          aws s3 cp ../frontend/index.html s3://$BUCKET_NAME/

      - name: Initialize DynamoDB counter
        run: |
          cd terraform
          TABLE_NAME=$(terraform output -raw dynamodb_table_name)
          aws dynamodb put-item \
            --table-name $TABLE_NAME \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          cd terraform
          API_URL=$(terraform output -raw api_gateway_url)
          echo "Testing GET request..."
          curl -f $API_URL
          echo "Testing POST request..."
          curl -f -X POST $API_URL