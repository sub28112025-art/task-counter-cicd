# Recreate the file from scratch to eliminate any hidden characters
cat > .github/workflows/cicd.yml << 'EOFWORKFLOW'
name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd lambda/task_counter
          pip install -r requirements.txt
          pip install pytest boto3

      - name: Run basic syntax check
        run: |
          python -m py_compile lambda/task_counter/handler.py

  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: test
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config=environments/dev/backend.hcl

      - name: Terraform Plan DEV
        run: |
          cd terraform
          terraform plan -var-file=environments/dev/terraform.tfvars

      - name: Terraform Apply DEV
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/dev/terraform.tfvars

      - name: Get outputs
        id: tf-outputs
        run: |
          cd terraform
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "table_name=$(terraform output -raw dynamodb_table_name)" >> $GITHUB_OUTPUT
          echo "website_url=$(terraform output -raw s3_website_url)" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.tf-outputs.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          aws s3 cp frontend/index.html s3://${{ steps.tf-outputs.outputs.bucket_name }}/

      - name: Initialize DynamoDB counter
        run: |
          aws dynamodb put-item \
            --table-name ${{ steps.tf-outputs.outputs.table_name }} \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          echo "Testing GET request..."
          curl -f ${{ steps.tf-outputs.outputs.api_url }}
          echo "Testing POST request..."
          curl -f -X POST ${{ steps.tf-outputs.outputs.api_url }}

      - name: Display website URL
        run: |
          echo "‚úÖ DEV deployment successful!"
          echo "üåê Website URL: http://${{ steps.tf-outputs.outputs.website_url }}"

  deploy-sit:
    name: Deploy to SIT
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: sit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config=environments/sit/backend.hcl

      - name: Terraform Apply SIT
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/sit/terraform.tfvars

      - name: Get outputs
        id: tf-outputs
        run: |
          cd terraform
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "table_name=$(terraform output -raw dynamodb_table_name)" >> $GITHUB_OUTPUT
          echo "website_url=$(terraform output -raw s3_website_url)" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.tf-outputs.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          aws s3 cp frontend/index.html s3://${{ steps.tf-outputs.outputs.bucket_name }}/

      - name: Initialize DynamoDB counter
        run: |
          aws dynamodb put-item \
            --table-name ${{ steps.tf-outputs.outputs.table_name }} \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          echo "Testing GET request..."
          curl -f ${{ steps.tf-outputs.outputs.api_url }}
          echo "Testing POST request..."
          curl -f -X POST ${{ steps.tf-outputs.outputs.api_url }}

      - name: Display website URL
        run: |
          echo "‚úÖ SIT deployment successful!"
          echo "üåê Website URL: http://${{ steps.tf-outputs.outputs.website_url }}"

  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-sit
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend-config=environments/prod/backend.hcl

      - name: Terraform Apply PROD
        run: |
          cd terraform
          terraform apply -auto-approve -var-file=environments/prod/terraform.tfvars

      - name: Get outputs
        id: tf-outputs
        run: |
          cd terraform
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "table_name=$(terraform output -raw dynamodb_table_name)" >> $GITHUB_OUTPUT
          echo "website_url=$(terraform output -raw s3_website_url)" >> $GITHUB_OUTPUT

      - name: Update frontend with API URL
        run: |
          sed -i "s|const API_URL = '.*';|const API_URL = '${{ steps.tf-outputs.outputs.api_url }}';|" frontend/index.html

      - name: Deploy frontend to S3
        run: |
          aws s3 cp frontend/index.html s3://${{ steps.tf-outputs.outputs.bucket_name }}/

      - name: Initialize DynamoDB counter
        run: |
          aws dynamodb put-item \
            --table-name ${{ steps.tf-outputs.outputs.table_name }} \
            --item '{"id": {"S": "counter"}, "count": {"N": "0"}}' || true

      - name: Run smoke tests
        run: |
          echo "Testing GET request..."
          curl -f ${{ steps.tf-outputs.outputs.api_url }}
          echo "Testing POST request..."
          curl -f -X POST ${{ steps.tf-outputs.outputs.api_url }}

      - name: Display website URL
        run: |
          echo "‚úÖ PROD deployment successful!"
          echo "üåê Website URL: http://${{ steps.tf-outputs.outputs.website_url }}"
EOFWORKFLOW